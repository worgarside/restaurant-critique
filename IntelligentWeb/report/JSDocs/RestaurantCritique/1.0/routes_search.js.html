<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: routes/search.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: routes/search.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Adds search functionality to site by aggregating Restaurant objects
 * @author Will Garside, Rufus Cope
 */

// ================ Middleware ================ \\

const express = require('express');
const router = express.Router();
const bodyParser = require('body-parser');
const mongoose = require('mongoose');
const Restaurant = mongoose.model('Restaurant');
router.use(bodyParser.urlencoded({extended: true}));

// ================ POST Method ================ \\

/**
 * Uses regex to search the Restaurants' 'searchable' attribute objects
 * Once matches have been found, the usable fields are projected to the client
 * Also adds a weight attribute for useful ordering
 * @function submitSearchQuery
 */
router.post('/', (req, res) => {
    const searchQueryData = req.body.searchQueryData.replace(/[^\w\s]/, ''); // remove special chars
    const regexQuery = `^(?=.*${searchQueryData.replace(new RegExp(' ', 'g'), ')(?=.*')}).*$`; // split for regex AND
    const re = new RegExp(regexQuery, 'i'); // turn to regex, case insensitive
    console.log(`Searching with ${re}`);

    Restaurant.aggregate(
        [
            {
                "$match": {'searchable.all': {$regex: re}},
            },
            {
                "$project": {
                    'name': 1,
                    'address': {'formattedAddress': 1},
                    'description': 1,
                    'categories': 1,
                    'images': 1,
                    'averageRating': 1,
                    'localUrl': 1,
                    'searchable': 1,
                    'weight': 1
                }
            }
        ], (err, restaurants) => {
            if (err) {
                console.log(`Error: ${err}`);
            }

            res.send(applyWeightings(restaurants, searchQueryData));
        }
    ).catch((err) => {
        console.log(`Restaurant aggregation failed: ${err}`);
    });
});

/**
 * Applies a weighting to each Restaurant by evaluating the similarity between the search query and the Restaurant data
 * Weight is added as such: Query word in the name +8; word in the description +4; Matched category +2; In Address +1
 * @param restaurants Returned list of search-matched restaurants
 * @param query The User's search query
 */
function applyWeightings(restaurants, query) {
    for (let restaurant of restaurants) {
        let weight = 0;
        for (let word of query.split(' ')) {
            // The split function returns empty strings if there are leading/trailing spaces
            if (word === '') continue;

            if (restaurant.searchable.name.toLowerCase().includes(word.toLowerCase())) weight += 8;

            if (restaurant.searchable.description.toLowerCase().includes(word.toLowerCase())) weight += 4;

            // Evaluate each Category in turn
            for (const category of restaurant.categories) {
                if (category.name.toLowerCase().includes(word.toLowerCase())) weight += 2;
            }

            if (restaurant.searchable.formattedAddress.toLowerCase().includes(word.toLowerCase())) weight += 1;
        }

        restaurant.weight = weight;
    }
    return restaurants.sort(compareRestaurants);
}

/**
 * Comparison method for the restaurants, called by the sort method
 * @param a The first Restaurant to be compared
 * @param b The second Restaurant to be compared
 * @returns {number} An integer indicative of the comparison, allows correct sorting
 */
function compareRestaurants(a, b) {
    const weightA = a.weight;
    const weightB = b.weight;

    if (weightA &lt; weightB) {
        return 1;
    } else if (weightA > weightB) {
        return -1;
    } else {
        return 0;
    }
}


module.exports = router;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addNewRestaurant">addNewRestaurant</a></li><li><a href="global.html#addUser">addUser</a></li><li><a href="global.html#applyWeightings">applyWeightings</a></li><li><a href="global.html#compareRestaurants">compareRestaurants</a></li><li><a href="global.html#connect">connect</a></li><li><a href="global.html#emailCreator">emailCreator</a></li><li><a href="global.html#generateHash">generateHash</a></li><li><a href="global.html#getNearbyRestaurants">getNearbyRestaurants</a></li><li><a href="global.html#initialiseDatabase">initialiseDatabase</a></li><li><a href="global.html#loadNewRestaurantPage">loadNewRestaurantPage</a></li><li><a href="global.html#loadRestaurantPage">loadRestaurantPage</a></li><li><a href="global.html#populateCategories">populateCategories</a></li><li><a href="global.html#populateCollections">populateCollections</a></li><li><a href="global.html#populateFunction">populateFunction</a></li><li><a href="global.html#populateRestaurants">populateRestaurants</a></li><li><a href="global.html#populateReviews">populateReviews</a></li><li><a href="global.html#populateUsers">populateUsers</a></li><li><a href="global.html#postContactForm">postContactForm</a></li><li><a href="global.html#sendConfirmationEmail">sendConfirmationEmail</a></li><li><a href="global.html#sendEmail">sendEmail</a></li><li><a href="global.html#sendSupportRequest">sendSupportRequest</a></li><li><a href="global.html#sendVerificationEmail">sendVerificationEmail</a></li><li><a href="global.html#storage">storage</a></li><li><a href="global.html#submitSearchQuery">submitSearchQuery</a></li><li><a href="global.html#userLogin">userLogin</a></li><li><a href="global.html#verifyUser">verifyUser</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Apr 13 2018 19:15:06 GMT+0100 (BST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
