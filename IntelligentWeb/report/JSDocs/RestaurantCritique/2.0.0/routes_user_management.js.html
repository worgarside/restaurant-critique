<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: routes/user_management.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: routes/user_management.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * User signup management, uses passport configuration file
 * @author Will Garside
 */

// ================ Middleware ================ \\

const express = require('express');
const router = express.Router();
const bodyParser = require('body-parser');
const mongoose = require('mongoose');
const fs = require('fs');
const User = mongoose.model('User');
const Review = mongoose.model('Review');
const Restaurant = mongoose.model('Restaurant');
const multer = require('multer');

router.use(bodyParser.urlencoded({extended: true}));

const storage = multer.diskStorage({
    destination: (req, file, callback) => {
        callback(null, './public/images/userImages');
    },
    filename: (req, file, callback) => {
        callback(null, req.user.reducedID);
    }
});
const upload = multer({storage: storage});

// ================================ User Details ================================ \\

router.post('/update_name', (req, res) => {
    User.findByIdAndUpdate(req.user._id, {name: req.body.name}, {new: true})
        .then((user) => {
            console.log(`Name updated successfully: '${user.name.first} ${user.name.last}'`);
            res.send(user.name);
        })
        .catch((err) => {
            console.log(err);
            res.send(false);
        });
});

router.post('/update_postcode', (req, res) => {
    User.findByIdAndUpdate(req.user._id, {postcode: req.body.postcode}, {new: true})
        .then(() => {
            console.log(`Postcode updated successfully: '${user.postcode}'`);
            res.send(user.postcode);
        })
        .catch(() => {
            console.log(err);
            res.send(false);
        });
});

router.post('/update_password', (req, res) => {
    User.findOne({_id: req.user._id})
        .then((user) => {
            user.comparePassword(req.body.password.old, (err, matched) => {
                if (err) {
                    console.log(`Error: ${err}`);
                    res.send('0');
                }

                if (matched) {
                    user.password = req.body.password.new;
                    user.save()
                        .then(() => {
                            res.send('1');
                        })
                        .catch((err) => {
                            console.log(`Unable to save user: ${err}`);
                            res.send('2');
                        })
                } else {
                    console.log('oldPassword &lt;> user.password');
                    res.send('0');
                }
            });
        })
        .catch((err) => {
            console.log(`Error: ${err}`);
            res.send('0');
        });
});

router.post('/update_image', upload.single('displayImage'), (req, res) => {
    res.send('');
});

// ================================ Restaurant Controls ================================ \\

router.post('/publish_restaurant', (req, res) => {
    Restaurant.findByIdAndUpdate(req.body.restaurantID, {
        published: true
    }, {new: true})
        .exec()
        .then((restaurant) => {
            const result = {
                success: true,
                url: `/restaurant/${restaurant.localUrl}`
            };
            res.send(result);
        })
        .catch((err) => {
            console.log(`Error: ${err}`);
            const result = {
                success: false,
                url: 'errors/500'
            };

            res.send(result);
        });
});

router.post('/delete_restaurant', (req, res) => {
    User.findByIdAndUpdate(
        req.user._id,
        {
            $pull: {
                'restaurants.created': req.body.restaurantID
            }
        }
    )
        .exec()
        .then(() => {
            Restaurant.findByIdAndRemove(req.body.restaurantID)
                .then(() => {
                    res.send({success: true});
                })
                .catch((err) => {
                    res.send({success: false});
                    console.log(`Restaurant delete error: ${err}`);
                });
        })
        .catch((err) => {
            res.send({success: false});
            console.log(`User $pull error: ${err}`);
        });

});

// ================================ Review Controls ================================ \\

router.post('/delete_review', (req, res) => {
    console.log(`Deleting review ${req.body.reviewID} by ${req.user.reducedID}`);

    Review.findOne({
        _id: req.body.reviewID,
        'author.reducedID': req.user.reducedID
    })
        .then((review) => {
            const restaurantPromise = Restaurant.findByIdAndUpdate(
                review.restaurant._id,
                {
                    $pull: {
                        images: {$in: review.images},
                        reviews: review._id
                    }
                }
            ).exec();

            const userPromise = User.findOneAndUpdate(
                {reducedID: review.author.reducedID},
                {
                    $pull: {
                        reviews: review._id
                    }
                }
            ).exec();

            Promise.all([restaurantPromise, userPromise])
                .then(() => {
                    deleteImages(review.restaurant._id, review.images);

                    review.remove()
                        .then(() => {
                            console.log('Review deleted successfully');
                            res.send(true);
                        }).catch((err) => {
                        console.log(`Review deletion failed: ${err}`);
                        res.send(false);
                    });
                })
                .catch((err) => {
                    console.log(`Document updates failed: ${err}`);
                    res.send(false);
                });
        })
        .catch((err) => {
            console.log(`Review lookup failed: ${err}`);
            res.send(false);
        });
});

/**
 * Delete the images from the server's directories when a review is deleted
 * @param restaurant - the restaurant whose images re being removed
 * @param images - the array of images to be removed
 */
function deleteImages(restaurant, images) {
    const directory = `./public/images/restaurants/${restaurant}/`;

    for (const image of images) {
        const imagePath = directory + image;
        console.log(`Deleting ${imagePath}`);
        fs.unlinkSync(imagePath);
    }
}

module.exports = router;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#activateServiceWorker">activateServiceWorker</a></li><li><a href="global.html#addNewRestaurant">addNewRestaurant</a></li><li><a href="global.html#addTimes">addTimes</a></li><li><a href="global.html#addUser">addUser</a></li><li><a href="global.html#allCategories">allCategories</a></li><li><a href="global.html#allowLocation">allowLocation</a></li><li><a href="global.html#applyWeightings">applyWeightings</a></li><li><a href="global.html#autoCapitalise">autoCapitalise</a></li><li><a href="global.html#autoTitleCase">autoTitleCase</a></li><li><a href="global.html#checkCategoryPicker">checkCategoryPicker</a></li><li><a href="global.html#checkNavPos">checkNavPos</a></li><li><a href="global.html#clearMarkers">clearMarkers</a></li><li><a href="global.html#compareRestaurants">compareRestaurants</a></li><li><a href="global.html#confirmEdit">confirmEdit</a></li><li><a href="global.html#confirmEditHTMLMod">confirmEditHTMLMod</a></li><li><a href="global.html#connect">connect</a></li><li><a href="global.html#createMap">createMap</a></li><li><a href="global.html#createRestaurantPreview">createRestaurantPreview</a></li><li><a href="global.html#dataCacheName">dataCacheName</a></li><li><a href="global.html#deleteImages">deleteImages</a></li><li><a href="global.html#displaySearchResults">displaySearchResults</a></li><li><a href="global.html#editAddress">editAddress</a></li><li><a href="global.html#editFoundAddress">editFoundAddress</a></li><li><a href="global.html#editMapAddress">editMapAddress</a></li><li><a href="global.html#emailCreator">emailCreator</a></li><li><a href="global.html#exitIfDBConnectionFailed">exitIfDBConnectionFailed</a></li><li><a href="global.html#fetchServiceWorker">fetchServiceWorker</a></li><li><a href="global.html#findAddress">findAddress</a></li><li><a href="global.html#generateHash">generateHash</a></li><li><a href="global.html#getAllCategories">getAllCategories</a></li><li><a href="global.html#getNearbyRestaurants">getNearbyRestaurants</a></li><li><a href="global.html#getRestaurantDiv">getRestaurantDiv</a></li><li><a href="global.html#hideCategoryDropdown">hideCategoryDropdown</a></li><li><a href="global.html#hideCategoryPicker">hideCategoryPicker</a></li><li><a href="global.html#hideCategorySelected">hideCategorySelected</a></li><li><a href="global.html#hideHTML">hideHTML</a></li><li><a href="global.html#initialiseDatabase">initialiseDatabase</a></li><li><a href="global.html#initMap">initMap</a></li><li><a href="global.html#initSlideshow">initSlideshow</a></li><li><a href="global.html#installServiceWorker">installServiceWorker</a></li><li><a href="global.html#lat">lat</a></li><li><a href="global.html#loadEditRestaurantPage">loadEditRestaurantPage</a></li><li><a href="global.html#loadNewRestaurantPage">loadNewRestaurantPage</a></li><li><a href="global.html#loadRestaurantPage">loadRestaurantPage</a></li><li><a href="global.html#lookupAddressToggle">lookupAddressToggle</a></li><li><a href="global.html#lookupMapToggle">lookupMapToggle</a></li><li><a href="global.html#manageGeolocation">manageGeolocation</a></li><li><a href="global.html#matchCategories">matchCategories</a></li><li><a href="global.html#pageCount">pageCount</a></li><li><a href="global.html#passportLogin">passportLogin</a></li><li><a href="global.html#passportSignUp">passportSignUp</a></li><li><a href="global.html#populateCollections">populateCollections</a></li><li><a href="global.html#populateFunction">populateFunction</a></li><li><a href="global.html#populateRestaurants">populateRestaurants</a></li><li><a href="global.html#populateReviews">populateReviews</a></li><li><a href="global.html#populateUsers">populateUsers</a></li><li><a href="global.html#postContactForm">postContactForm</a></li><li><a href="global.html#previewImage">previewImage</a></li><li><a href="global.html#processImages">processImages</a></li><li><a href="global.html#processRestaurants">processRestaurants</a></li><li><a href="global.html#publishRestaurant">publishRestaurant</a></li><li><a href="global.html#redirectAfterVerified">redirectAfterVerified</a></li><li><a href="global.html#refreshTopRestaurants">refreshTopRestaurants</a></li><li><a href="global.html#removeCategory">removeCategory</a></li><li><a href="global.html#removeSelectedDay">removeSelectedDay</a></li><li><a href="global.html#saveRestaurant">saveRestaurant</a></li><li><a href="global.html#scrollToRestaurant">scrollToRestaurant</a></li><li><a href="global.html#search">search</a></li><li><a href="global.html#selectCategory">selectCategory</a></li><li><a href="global.html#sendConfirmationEmail">sendConfirmationEmail</a></li><li><a href="global.html#sendEmail">sendEmail</a></li><li><a href="global.html#sendSupportRequest">sendSupportRequest</a></li><li><a href="global.html#setLoginFormPosition">setLoginFormPosition</a></li><li><a href="global.html#showCategoryDropdown">showCategoryDropdown</a></li><li><a href="global.html#showHTML">showHTML</a></li><li><a href="global.html#sortResults">sortResults</a></li><li><a href="global.html#storage">storage</a></li><li><a href="global.html#submitReview">submitReview</a></li><li><a href="global.html#submitSearchQuery">submitSearchQuery</a></li><li><a href="global.html#syncServiceWorker">syncServiceWorker</a></li><li><a href="global.html#updateCategoryCheckboxes">updateCategoryCheckboxes</a></li><li><a href="global.html#updateDetails">updateDetails</a></li><li><a href="global.html#updateDisplayFlags">updateDisplayFlags</a></li><li><a href="global.html#updateFeaturesCheckboxes">updateFeaturesCheckboxes</a></li><li><a href="global.html#updateImagePreviews">updateImagePreviews</a></li><li><a href="global.html#updateList">updateList</a></li><li><a href="global.html#updateNearbyDistance">updateNearbyDistance</a></li><li><a href="global.html#userLogin">userLogin</a></li><li><a href="global.html#validateSignUpForm">validateSignUpForm</a></li><li><a href="global.html#validPassword">validPassword</a></li><li><a href="global.html#verifyEmail">verifyEmail</a></li><li><a href="global.html#verifyUser">verifyUser</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Jun 01 2018 12:51:05 GMT+0100 (GMT Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
