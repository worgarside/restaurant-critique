<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: routes/restaurant.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: routes/restaurant.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Routing file for new Review upload on restaurant page
 * Management of inserting new Review to the database and rerouting back to the page with review displayed
 * @author Greta Ramaneckaite, Rufus Cope
 */

// ================ Middleware ================ \\

const express = require('express');
const router = express.Router();
const bodyParser = require('body-parser');
const fs = require('fs');
const dateFormat = require('dateformat');
const mongoose = require('mongoose');
const Restaurant = mongoose.model('Restaurant');
const User = mongoose.model('User');
const Review = mongoose.model('Review');

router.use(bodyParser.urlencoded({extended: true}));

// ================================ POST Method ================================ \\

/**
 * Sets image file names and saves them to the correct directory when a restaurant is added to the site
 * @param imageArray - array of images to be processed
 * @param restaurantId - ID of restaurant being edited
 * @returns {Array} - array of image filenames to be added to relevant field in Review object
 */
function processImages(imageArray, restaurantId) {
    const now = dateFormat(new Date(), 'yyyy-mm-dd HH-MM-ss');
    const targetDirectory = `./public/images/restaurants/${restaurantId}/`;

    if (!fs.existsSync(targetDirectory)) {
        fs.mkdirSync(targetDirectory);
    }

    let imageNames = [];

    for (let i = 0; i &lt; imageArray.length - 1; i++) {
        let image = imageArray[i];
        // strip off the data: url prefix to get just the base64-encoded bytes
        let imageBlob = image.replace(/^data:image\/\w+;base64,/, '');
        let buf = new Buffer(imageBlob, 'base64');
        const imageName = `${now}_${i}.png`;
        const filePath = targetDirectory + imageName;

        fs.writeFile(filePath, buf, (err) => {
            if (err) throw err;
        });

        imageNames.push(imageName);
    }

    console.log(`Saved ${imageNames.length} images`);
    return imageNames;
}

 const returnFunction = function (io) {
    // io.on('connection', (socket) => {
    //     socket.on('chat message', (msg) => {
    //         console.log(`Message received: ${msg}`);
    //         io.emit('chat message', msg);
    //     });
    // });

     router.post('/submit_review', (req, res) => {
         console.log(`Review:
    Title: ${req.body.title}
    Rating: ${req.body.rating}
    Body: ${req.body.body}
    Restaurant: ${req.body.restaurantId}  
    User: ${req.user._id}
    imageBlob.length: ${req.body['imageBlob[]'].length}
    `);

         let review = new Review({
             restaurant: {
                 _id: req.body.restaurantId
             },
             title: req.body.title,
             body: req.body.body,
             author: {
                 forename: req.user.name.first,
                 surname: req.user.name.last,
                 reducedID: req.user.reducedID
             },
             restaurantRating: req.body.rating,
         });

         const reviewImages = processImages(req.body['imageBlob[]'], req.body.restaurantId);
         review.images = reviewImages;

         review.save()
             .then(() => {
                 console.log('Review added to collection');

                 // Add the Restaurant ID to the User's attribute
                 User.findByIdAndUpdate(
                     req.user._id,
                     {$push: {reviews: review._id.toString()}},
                     (err) => {
                         if (err) {
                             console.log(`User error: ${err}`);
                         } else {
                             console.log('User fields updated');
                         }
                     });
                 Restaurant.findOne({_id: req.body.restaurantId})
                     .then((restaurant) => {
                         const reviewCount = restaurant.reviews.length;
                         const oldRating = restaurant.averageRating;
                         const newRating = ((oldRating * reviewCount) + review.restaurantRating) / (reviewCount + 1);

                         Restaurant.findByIdAndUpdate(
                             req.body.restaurantId,
                             {
                                 $push: {images: {$each: reviewImages}, reviews: review._id.toString()},
                                 $set: {averageRating: newRating}
                             },
                             (err) => {
                                 if (err) {
                                     console.log(`Restaurant update error: ${err}`);
                                 } else {
                                     console.log('Restaurant fields updated');
                                 }
                             });
                         io.emit('review', review);
                         res.send({success: true});
                     })
                     .catch((err) => {
                         console.log(`Restaurant lookup error: ${err}`);
                     });
             })
             .catch((err) => {
                 console.log(`Error saving review: ${err}`);
                 res.end();
             });
     });

    return router;
};

module.exports = returnFunction;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addNewRestaurant">addNewRestaurant</a></li><li><a href="global.html#addTimes">addTimes</a></li><li><a href="global.html#addUser">addUser</a></li><li><a href="global.html#allCategories">allCategories</a></li><li><a href="global.html#allowLocation">allowLocation</a></li><li><a href="global.html#applyWeightings">applyWeightings</a></li><li><a href="global.html#autoCapitalise">autoCapitalise</a></li><li><a href="global.html#autoTitleCase">autoTitleCase</a></li><li><a href="global.html#checkCategoryPicker">checkCategoryPicker</a></li><li><a href="global.html#checkNavPos">checkNavPos</a></li><li><a href="global.html#clearMarkers">clearMarkers</a></li><li><a href="global.html#compareRestaurants">compareRestaurants</a></li><li><a href="global.html#confirmEdit">confirmEdit</a></li><li><a href="global.html#confirmEditHTMLMod">confirmEditHTMLMod</a></li><li><a href="global.html#connect">connect</a></li><li><a href="global.html#createMap">createMap</a></li><li><a href="global.html#createRestaurantPreview">createRestaurantPreview</a></li><li><a href="global.html#deleteImages">deleteImages</a></li><li><a href="global.html#displaySearchResults">displaySearchResults</a></li><li><a href="global.html#editAddress">editAddress</a></li><li><a href="global.html#editFoundAddress">editFoundAddress</a></li><li><a href="global.html#editMapAddress">editMapAddress</a></li><li><a href="global.html#emailCreator">emailCreator</a></li><li><a href="global.html#exitIfDBConnectionFailed">exitIfDBConnectionFailed</a></li><li><a href="global.html#findAddress">findAddress</a></li><li><a href="global.html#generateHash">generateHash</a></li><li><a href="global.html#getAllCategories">getAllCategories</a></li><li><a href="global.html#getNearbyRestaurants">getNearbyRestaurants</a></li><li><a href="global.html#getRestaurantDiv">getRestaurantDiv</a></li><li><a href="global.html#hideCategoryDropdown">hideCategoryDropdown</a></li><li><a href="global.html#hideCategoryPicker">hideCategoryPicker</a></li><li><a href="global.html#hideCategorySelected">hideCategorySelected</a></li><li><a href="global.html#hideHTML">hideHTML</a></li><li><a href="global.html#initialiseDatabase">initialiseDatabase</a></li><li><a href="global.html#initMap">initMap</a></li><li><a href="global.html#initSlideshow">initSlideshow</a></li><li><a href="global.html#lat">lat</a></li><li><a href="global.html#loadEditRestaurantPage">loadEditRestaurantPage</a></li><li><a href="global.html#loadNewRestaurantPage">loadNewRestaurantPage</a></li><li><a href="global.html#loadRestaurantPage">loadRestaurantPage</a></li><li><a href="global.html#lookupAddressToggle">lookupAddressToggle</a></li><li><a href="global.html#lookupMapToggle">lookupMapToggle</a></li><li><a href="global.html#manageGeolocation">manageGeolocation</a></li><li><a href="global.html#matchCategories">matchCategories</a></li><li><a href="global.html#pageCount">pageCount</a></li><li><a href="global.html#passportLogin">passportLogin</a></li><li><a href="global.html#passportSignUp">passportSignUp</a></li><li><a href="global.html#populateCollections">populateCollections</a></li><li><a href="global.html#populateFunction">populateFunction</a></li><li><a href="global.html#populateRestaurants">populateRestaurants</a></li><li><a href="global.html#populateReviews">populateReviews</a></li><li><a href="global.html#populateUsers">populateUsers</a></li><li><a href="global.html#postContactForm">postContactForm</a></li><li><a href="global.html#previewImage">previewImage</a></li><li><a href="global.html#processImages">processImages</a></li><li><a href="global.html#processRestaurants">processRestaurants</a></li><li><a href="global.html#publishRestaurant">publishRestaurant</a></li><li><a href="global.html#redirectAfterVerified">redirectAfterVerified</a></li><li><a href="global.html#refreshTopRestaurants">refreshTopRestaurants</a></li><li><a href="global.html#removeCategory">removeCategory</a></li><li><a href="global.html#removeSelectedDay">removeSelectedDay</a></li><li><a href="global.html#saveRestaurant">saveRestaurant</a></li><li><a href="global.html#scrollToRestaurant">scrollToRestaurant</a></li><li><a href="global.html#search">search</a></li><li><a href="global.html#selectCategory">selectCategory</a></li><li><a href="global.html#sendConfirmationEmail">sendConfirmationEmail</a></li><li><a href="global.html#sendEmail">sendEmail</a></li><li><a href="global.html#sendSupportRequest">sendSupportRequest</a></li><li><a href="global.html#setLoginFormPosition">setLoginFormPosition</a></li><li><a href="global.html#showCategoryDropdown">showCategoryDropdown</a></li><li><a href="global.html#showHTML">showHTML</a></li><li><a href="global.html#sortResults">sortResults</a></li><li><a href="global.html#storage">storage</a></li><li><a href="global.html#submitReview">submitReview</a></li><li><a href="global.html#submitSearchQuery">submitSearchQuery</a></li><li><a href="global.html#updateCategoryCheckboxes">updateCategoryCheckboxes</a></li><li><a href="global.html#updateDetails">updateDetails</a></li><li><a href="global.html#updateDisplayFlags">updateDisplayFlags</a></li><li><a href="global.html#updateFeaturesCheckboxes">updateFeaturesCheckboxes</a></li><li><a href="global.html#updateImagePreviews">updateImagePreviews</a></li><li><a href="global.html#updateList">updateList</a></li><li><a href="global.html#updateNearbyDistance">updateNearbyDistance</a></li><li><a href="global.html#userLogin">userLogin</a></li><li><a href="global.html#validateSignUpForm">validateSignUpForm</a></li><li><a href="global.html#validPassword">validPassword</a></li><li><a href="global.html#verifyEmail">verifyEmail</a></li><li><a href="global.html#verifyUser">verifyUser</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu May 31 2018 16:05:40 GMT+0100 (GMT Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
