<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: public/javascripts/restaurants_nearby.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: public/javascripts/restaurants_nearby.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * restaurants_nearby.js
 * Client-side JS
 * @author Will Garside
 */

let lat, lng, map, userMarker;
let markerList = [];
let nearbyRestaurants = [];
let distanceSlider = $('#distance-slider');
let distanceSliderValue = $('#distance-slider-value');

$('#login-warning').click(() => {
    $('#btn-login').click();
});

$('#allow-location').click(() => {
    allowLocation(true);
});

$('#deny-location').click(() => {
    allowLocation(false);
});

/**
 * Function to get Users location from browser geolocation after they allow it
 * @param {Boolean} allowed Flag to signify whether the User has allowed geolocation or not
 */
function allowLocation(allowed) {
    if (allowed) {
        sessionStorage.setItem('allowLocation', true);

        const options = {enableHighAccuracy: true, timeout: 10000, maximumAge: 750000};
        navigator.geolocation.getCurrentPosition((position) => {
            lat = position.coords.latitude;
            lng = position.coords.longitude;

            map.setCenter({lat: lat, lng: lng});
            userMarker.setPosition(new google.maps.LatLng(lat, lng));
            console.log('Geolocation succeeded!');
            updateList();
        }, () => {
            console.log('Geolocation failed :(');
        }, options)
    } else {
        sessionStorage.setItem('allowLocation', false);
    }

    $('#restaurant-location-overlay').css('display', 'none');
}

/**
 * Retrieves the user's preference for being located from the session storage and passes the parameters
 * (or asks the user) accordingly
 */
function manageGeolocation() {
    if (userLoggedIn) {
        const locFlag = sessionStorage.getItem('allowLocation');

        if (locFlag === 'true') {
            // console.log('Location already allowed');
            allowLocation(true);
        } else if (locFlag === 'false') {
            // console.log('Location already denied');
            allowLocation(false);
        } else {
            // console.log('Location permissions not set');
            $('#restaurant-location-overlay').css('display', 'block');
        }
    }
}

/**
 * Called by GMaps script after map is loaded
 * Initialises Google Map V3 attributes
 */
function initMap() {
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({'address': `${postcode}, UK`}, (results, status) => {
        if (status === google.maps.GeocoderStatus.OK) {
            lat = results[0].geometry.location.lat();
            lng = results[0].geometry.location.lng();
            createMap();
        } else {
            alert(`Geocoding your location has failed. Please refresh the page or try again later.`);
            console.log(`Geocode error: ${status}`);
        }
    });
}

/**
 * Creates the map on the page, with the User at the centre and with a marker to show their location
 */
function createMap() {
    const currentLocation = {lat: lat, lng: lng};
    console.log(`Creating the map @ ${currentLocation.lat}, ${currentLocation.lng}`);

    const styles = [
        {
            "featureType": "poi.business",
            "stylers": [
                {"visibility": "off"}
            ]
        }
    ];

    if (userLoggedIn) {
        map = new google.maps.Map($('#nearby-map')[0], {
            zoom: 14,
            center: currentLocation,
            styles: styles,
            zoomControl: true,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true
        });

        userMarker = new google.maps.Marker({
            map: map,
            draggable: true,
            animation: google.maps.Animation.DROP,
            position: currentLocation
        });

        google.maps.event.addListener(userMarker, 'dragend', () => {
            lat = userMarker.getPosition().lat();
            lng = userMarker.getPosition().lng();
            updateList();
        });
    } else {
        map = new google.maps.Map($('#nearby-map')[0], {
            zoom: 14,
            center: currentLocation,
            draggable: true,
            styles: styles,
            zoomControl: true,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true
        });

        userMarker = new google.maps.Marker({
            map: map,
            animation: google.maps.Animation.DROP,
            position: currentLocation
        });

        google.maps.event.addListener(userMarker, 'click', () => {
            $('#btn-login').click();
        });

        google.maps.event.addListener(userMarker, 'dragstart', () => {
            $('#btn-login').click();
        });
    }
    manageGeolocation();
    updateList();
}

/**
 * Sends an AJAX POST request to the server to get a list of nearby Restaurants
 * @see routes/restaurants_nearby.js
 */
function updateList() {
    const coordinates = JSON.stringify({lat: lat, lng: lng});

    $.ajax({
        url: '/restaurants-nearby',
        data: coordinates,
        contentType: 'application/json; charset=utf-8',
        type: 'POST',
        success: (restaurants) => {
            nearbyRestaurants = restaurants;
            processRestaurants();
        },
        error: (err) => {
            console.log(`Error: ${JSON.stringify(err)}`);
        }
    });
}

/**
 * Process the returned list of restaurants to create HTML for them and append it to the page
 * Also adds their locations to the map with markers and info windows
 * @see updateList()
 */
function processRestaurants() {
    clearMarkers();

    const restaurantListDOM = $('#restaurant-list')[0];
    restaurantListDOM.innerHTML = null;

    const icon = {
        url: '/images/site/gmaps-custom-pin-small.png',
        scaledSize: new google.maps.Size(25, 42)
    };

    markerList = [];
    let infoWindow = new google.maps.InfoWindow();
    let htmlString = '&lt;br/>';

    let resultsDisplayed = false;
    for (const [index, restaurant] of nearbyRestaurants.entries()) {
        if (restaurant.published &amp;&amp; (restaurant.distance &lt;= distanceSlider.val() * 1000)) {
            resultsDisplayed = true;
            htmlString += createRestaurantPreview(restaurant, index);

            const infoWindowContent = `
                &lt;div class='container' id='info-${index}' style='max-width: 400px;'>
                    &lt;div class='row'>
                        &lt;div class='col'>
                            &lt;h6 class='mb-1'>&lt;strong>${restaurant.name}&lt;/strong>&lt;/h6>
                            &lt;p class='mb-1'>${(restaurant.distance / 1000).toFixed(2)}km away&lt;/p>
                            &lt;p class='mb-1'>${restaurant.description}&lt;/p>
                            &lt;a onclick='scrollToRestaurant(${index});' href='javascript:void(0)'>More info&lt;/a>
                        &lt;/div>
                    &lt;/div>
                &lt;/div>
            `;

            const newMarker = new google.maps.Marker({
                title: restaurant.name,
                map: map,
                position: {lat: restaurant.address.latitude, lng: restaurant.address.longitude},
                icon: icon
            });

            google.maps.event.addListener(newMarker, 'click', function () {
                infoWindow.setContent(infoWindowContent);
                infoWindow.open(map, this);
            });

            markerList.push(newMarker);
        }
    }

    if (!resultsDisplayed) {
        htmlString = "&lt;h5 class='mt-2' style='margin-left: 4rem;'>No restaurants found in the chosen area.&lt;/h5>";
    }

    let resultContainer = document.createElement('div');
    resultContainer.innerHTML = htmlString;
    restaurantListDOM.appendChild(resultContainer);

    for (let i = 0; i &lt; nearbyRestaurants.length; i++) {
        initSlideshow(i);
    }
    updateJQueryClickables();
}

/**
 * Update the nearby results when the distance parameter is changed
 * @function updateNearbyDistance
 */
distanceSlider.on('input', () => {
    distanceSliderValue.text(`${distanceSlider.val()} km`);
    processRestaurants();
});


/**
 * Remove all markers on the nearby map and clear the markerList array
 */
function clearMarkers() {
    for (let i = 0; i &lt; markerList.length; i++) {
        markerList[i].setMap(null);
    }
    markerList = [];
}

/**
 * Dynamically creates a Restaurant preview 'card' to add to the page from the Restaurant info
 * It checks each of the relevant Restaurant attributes and uses them to fill out a HTML template
 * @param {Restaurant} restaurant The Restaurant being previewed
 * @param {number} index The number the Restaurant is on the page, used for setting button IDs
 * @returns {string} The generated HTML to be appended to the page
 * @author Will Garside
 */
function createRestaurantPreview(restaurant, index) {
    const htmlStart = `
        &lt;div class='container restaurant-card' id='restaurant-container-${index}'>
            &lt;div class='row'>
                &lt;div class='col-12 col-lg-8'>
                    &lt;div class='vert-center-parent'>
                        &lt;div class='vert-center-child'>
                            &lt;div class='row'>
                                &lt;div class='col'>
                                    &lt;a href='restaurant/${restaurant.localUrl}' class='restaurant-title d-inline'>${restaurant.name}&lt;/a>
    `;

    let htmlStars = '';

    if (restaurant.averageRating) {
        const starRating = Math.round(restaurant.averageRating);

        htmlStars = `
            &lt;div class='restaurant-stars'>
        `;

        for (let i = 0; i &lt; starRating; i++) {
            htmlStars += `&lt;span class='oi oi-star star-highlight'>&lt;/span>`;
        }

        for (let i = 0; i &lt; (5 - starRating); i++) {
            htmlStars += `&lt;span class='oi oi-star'>&lt;/span>`;
        }

        htmlStars += '&lt;/div>';
    }

    const htmlAddress = `
            &lt;/div>
        &lt;/div>
        &lt;div class='row'>
            &lt;div class='col'>
                &lt;a href='javascript:void(0)' class='restaurant-card-map-link restaurant-address' data-restaurant-name="${restaurant.name}">
                    &lt;img src='/images/site/gmaps-custom-pin-small.png'/>
                    ${restaurant.address.formattedAddress}
                &lt;/a>
            &lt;/div>
        &lt;/div>
    `;

    let htmlCategories = `
        &lt;div class='row'>
            &lt;div class='col'>
    `;

    if (restaurant.categories.length > 0) {
        for (const category of restaurant.categories) {
            htmlCategories += `&lt;p class='restaurant-category'>${category.name}&lt;/p>`;
        }
    }

    htmlCategories += `     
            &lt;/div>
        &lt;/div>
    `;

    let htmlDescription = '';

    if (restaurant.description !== 'No description currently available.') {
        htmlDescription = `
            &lt;div class='row'>
                &lt;div class='col'>
                    &lt;p class='restaurant-description'>${restaurant.description}&lt;/p>
                &lt;/div>
            &lt;/div>
        `;
    }

    let htmlSlideshow = `
                    &lt;/div>
                &lt;/div>
            &lt;/div>
            &lt;div class='col-12 col-lg-4'>
                &lt;div class='row'>
                    &lt;div class='col'>
                        &lt;div class='restaurant-nearby-images'>
                            &lt;div class='slideshow-wrapper'>
        `;

    let imageCount = 0;

    if (restaurant.images.length > 0) {
        htmlSlideshow += "&lt;div class='slideshow'>";
        for (const image of restaurant.images) {
            htmlSlideshow += `&lt;img src='images/restaurants/${restaurant._id}/${image}' class='slide-${index}'/>`;
            imageCount += 1;
            if (imageCount >= 3) {
                // only show first 3 images
                break;
            }
        }
        htmlSlideshow += '&lt;/div>';
    }

    if (imageCount > 1) {
        htmlSlideshow += `
                &lt;div id='button-prev-${index}' class='slideshow-prev'>
                    &lt;span class='oi oi-chevron-left'>&lt;/span>
                &lt;/div>
                &lt;div id='button-next-${index}' class='slideshow-next'>
                    &lt;span class='oi oi-chevron-right'>&lt;/span>
                &lt;/div>
        `;
    }

    htmlSlideshow += "&lt;/div>";

    const htmlEnd = `&lt;/div>&lt;/div>&lt;/div>&lt;/div>&lt;/div>&lt;/div>`;

    return htmlStart + htmlStars + htmlAddress + htmlCategories + htmlDescription + htmlSlideshow + htmlEnd;
}

/**
 * Image slideshow navigation using buttons on page
 * JQuery selectors have to be re-used due to the changing classes of the images
 * @param {number} value The index value of the slideshow, so multiple ones can be on the page simultaneously without controls
 * getting mixed up
 * @author Will Garside
 */
function initSlideshow(value) {
    const btnNext = $(`#button-next-${value}`);
    const btnPrev = $(`#button-prev-${value}`);

    $(`.slide-${value}`).first().addClass(`current-${value}`);
    $(`.slide-${value}`).hide();
    $(`.current-${value}`).show();

    // noinspection JSJQueryEfficiency
    btnNext.click(() => {
        $(`.current-${value}`).removeClass(`current-${value}`).addClass(`previous-${value}`);
        if ($(`.previous-${value}`).is(':last-child')) {
            $(`.slide-${value}`).first().addClass(`current-${value}`);
        } else {
            $(`.previous-${value}`).next().addClass(`current-${value}`);
        }
        $(`.previous-${value}`).removeClass(`previous-${value}`);
        $(`.slide-${value}`).fadeOut();
        $(`.current-${value}`).fadeIn();
    });

    btnPrev.click(() => {
        $(`.current-${value}`).removeClass(`current-${value}`).addClass(`previous-${value}`);
        if ($(`.previous-${value}`).is(':first-child')) {
            $(`.slide-${value}`).last().addClass(`current-${value}`);
        } else {
            $(`.previous-${value}`).prev().addClass(`current-${value}`);
        }
        $(`.previous-${value}`).removeClass(`previous-${value}`);
        $(`.slide-${value}`).fadeOut();
        $(`.current-${value}`).fadeIn();
    });
}

/**
 * Auto-scrolls to Restaurant preview from the link in the map infowindow
 * @param {number} index The index of the Restaurant
 */
function scrollToRestaurant(index) {
    $('html, body').animate({
        scrollTop: $(`#restaurant-container-${index}`).offset().top - 60
    }, 800);
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addNewRestaurant">addNewRestaurant</a></li><li><a href="global.html#addTimes">addTimes</a></li><li><a href="global.html#addUser">addUser</a></li><li><a href="global.html#allCategories">allCategories</a></li><li><a href="global.html#allowLocation">allowLocation</a></li><li><a href="global.html#applyWeightings">applyWeightings</a></li><li><a href="global.html#autoCapitalise">autoCapitalise</a></li><li><a href="global.html#autoTitleCase">autoTitleCase</a></li><li><a href="global.html#checkCategoryPicker">checkCategoryPicker</a></li><li><a href="global.html#checkNavPos">checkNavPos</a></li><li><a href="global.html#clearMarkers">clearMarkers</a></li><li><a href="global.html#compareRestaurants">compareRestaurants</a></li><li><a href="global.html#confirmEdit">confirmEdit</a></li><li><a href="global.html#confirmEditHTMLMod">confirmEditHTMLMod</a></li><li><a href="global.html#connect">connect</a></li><li><a href="global.html#createMap">createMap</a></li><li><a href="global.html#createRestaurantPreview">createRestaurantPreview</a></li><li><a href="global.html#deleteImages">deleteImages</a></li><li><a href="global.html#displaySearchResults">displaySearchResults</a></li><li><a href="global.html#editAddress">editAddress</a></li><li><a href="global.html#editFoundAddress">editFoundAddress</a></li><li><a href="global.html#editMapAddress">editMapAddress</a></li><li><a href="global.html#emailCreator">emailCreator</a></li><li><a href="global.html#exitIfDBConnectionFailed">exitIfDBConnectionFailed</a></li><li><a href="global.html#findAddress">findAddress</a></li><li><a href="global.html#generateHash">generateHash</a></li><li><a href="global.html#getAllCategories">getAllCategories</a></li><li><a href="global.html#getNearbyRestaurants">getNearbyRestaurants</a></li><li><a href="global.html#getRestaurantDiv">getRestaurantDiv</a></li><li><a href="global.html#hideCategoryDropdown">hideCategoryDropdown</a></li><li><a href="global.html#hideCategoryPicker">hideCategoryPicker</a></li><li><a href="global.html#hideCategorySelected">hideCategorySelected</a></li><li><a href="global.html#hideHTML">hideHTML</a></li><li><a href="global.html#initialiseDatabase">initialiseDatabase</a></li><li><a href="global.html#initMap">initMap</a></li><li><a href="global.html#initSlideshow">initSlideshow</a></li><li><a href="global.html#lat">lat</a></li><li><a href="global.html#loadEditRestaurantPage">loadEditRestaurantPage</a></li><li><a href="global.html#loadNewRestaurantPage">loadNewRestaurantPage</a></li><li><a href="global.html#loadRestaurantPage">loadRestaurantPage</a></li><li><a href="global.html#lookupAddressToggle">lookupAddressToggle</a></li><li><a href="global.html#lookupMapToggle">lookupMapToggle</a></li><li><a href="global.html#manageGeolocation">manageGeolocation</a></li><li><a href="global.html#matchCategories">matchCategories</a></li><li><a href="global.html#pageCount">pageCount</a></li><li><a href="global.html#passportLogin">passportLogin</a></li><li><a href="global.html#passportSignUp">passportSignUp</a></li><li><a href="global.html#populateCollections">populateCollections</a></li><li><a href="global.html#populateFunction">populateFunction</a></li><li><a href="global.html#populateRestaurants">populateRestaurants</a></li><li><a href="global.html#populateReviews">populateReviews</a></li><li><a href="global.html#populateUsers">populateUsers</a></li><li><a href="global.html#postContactForm">postContactForm</a></li><li><a href="global.html#previewImage">previewImage</a></li><li><a href="global.html#processImages">processImages</a></li><li><a href="global.html#processRestaurants">processRestaurants</a></li><li><a href="global.html#publishRestaurant">publishRestaurant</a></li><li><a href="global.html#redirectAfterVerified">redirectAfterVerified</a></li><li><a href="global.html#refreshTopRestaurants">refreshTopRestaurants</a></li><li><a href="global.html#removeCategory">removeCategory</a></li><li><a href="global.html#removeSelectedDay">removeSelectedDay</a></li><li><a href="global.html#saveRestaurant">saveRestaurant</a></li><li><a href="global.html#scrollToRestaurant">scrollToRestaurant</a></li><li><a href="global.html#search">search</a></li><li><a href="global.html#selectCategory">selectCategory</a></li><li><a href="global.html#sendConfirmationEmail">sendConfirmationEmail</a></li><li><a href="global.html#sendEmail">sendEmail</a></li><li><a href="global.html#sendSupportRequest">sendSupportRequest</a></li><li><a href="global.html#setLoginFormPosition">setLoginFormPosition</a></li><li><a href="global.html#showCategoryDropdown">showCategoryDropdown</a></li><li><a href="global.html#showHTML">showHTML</a></li><li><a href="global.html#sortResults">sortResults</a></li><li><a href="global.html#storage">storage</a></li><li><a href="global.html#submitReview">submitReview</a></li><li><a href="global.html#submitSearchQuery">submitSearchQuery</a></li><li><a href="global.html#updateCategoryCheckboxes">updateCategoryCheckboxes</a></li><li><a href="global.html#updateDetails">updateDetails</a></li><li><a href="global.html#updateDisplayFlags">updateDisplayFlags</a></li><li><a href="global.html#updateFeaturesCheckboxes">updateFeaturesCheckboxes</a></li><li><a href="global.html#updateImagePreviews">updateImagePreviews</a></li><li><a href="global.html#updateList">updateList</a></li><li><a href="global.html#updateNearbyDistance">updateNearbyDistance</a></li><li><a href="global.html#userLogin">userLogin</a></li><li><a href="global.html#validateSignUpForm">validateSignUpForm</a></li><li><a href="global.html#validPassword">validPassword</a></li><li><a href="global.html#verifyEmail">verifyEmail</a></li><li><a href="global.html#verifyUser">verifyUser</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu May 31 2018 11:32:56 GMT+0100 (GMT Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
