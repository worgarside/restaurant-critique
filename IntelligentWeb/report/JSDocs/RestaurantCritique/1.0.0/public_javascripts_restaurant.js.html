<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: public/javascripts/restaurant.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: public/javascripts/restaurant.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * restaurant.js
 * Client-side JS
 * @author Greta Ramaneckaite, Will Garside, Rufus Cope
 * @param {Array} coordinates
 */


// ================================ Google Maps ================================ \\

/**
 * Called by GMaps script after map is loaded
 * Initialises Google Map V3 attributes and markers
 */
function initMap() {
    const currentLocation = {lat: coordinates[1], lng: coordinates[0]};

    const styles = [{
        "featureType": "poi.business",
        "stylers": [
            {"visibility": "off"}
        ]
    }];

    map = new google.maps.Map($('#restaurant-current-map')[0], {
        zoom: 14,
        center: currentLocation,
        styles: styles
    });

    userMarker = new google.maps.Marker({
        map: map,
        draggable: false,
        animation: google.maps.Animation.DROP,
        position: currentLocation
    });

    google.maps.event.addListener(userMarker, 'dragend', () => {
        lat = userMarker.getPosition().lat();
        lng = userMarker.getPosition().lng();
        map.setCenter({lat: lat, lng: lng});
    });
}

// ================================ Image Viewer ================================ \\

const imageViewer = $('#full-screen-image-viewer');
let primaryPos = 0;
const prevImage = imageViewer.find('#prev-image');
const nextImage = imageViewer.find('#next-image');
const closeButton = imageViewer.find('#close-button');
const authorInfo = imageViewer.find('#author-info');
const authorImage = authorInfo.find('#author-image');
const authorName = authorInfo.find('p');

$('img.pointer').click(function () {
    if ($(window).width() > 700) {
        const currentSource = this.src;
        const currentImage = currentSource.substr(currentSource.lastIndexOf('/') + 1).replace(/(%20)/, ' ');
        primaryPos = images.indexOf(currentImage);
        updateImageViewer();
    }
});

prevImage.click(() => {
    primaryPos--;
    if (primaryPos &lt; 0) {
        primaryPos += images.length;
    }
    updateImageViewer();
});

nextImage.click(() => {
    primaryPos++;
    primaryPos = primaryPos % images.length;
    updateImageViewer();
});

closeButton.click(() => {
    imageViewer.hide();
});

function updateImageViewer() {
    const viewerImages = [];

    for (let i = 0; i &lt; images.length; i++) {
        let pointer = (i + primaryPos) % images.length;
        viewerImages.push(images[pointer]);
    }

    // noinspection FallThroughInSwitchStatementJS
    switch (viewerImages.length) {
        case 4:
            imageViewer.find('#fourth-image img').attr('src', `/images/restaurants/${restaurantId}/${viewerImages[3]}`);
        case 3:
            imageViewer.find('#third-image img').attr('src', `/images/restaurants/${restaurantId}/${viewerImages[2]}`);
        case 2:
            imageViewer.find('#second-image img').attr('src', `/images/restaurants/${restaurantId}/${viewerImages[1]}`);
        case 1:
            imageViewer.find('#main-image').attr('src', `/images/restaurants/${restaurantId}/${viewerImages[0]}`);
            break;
        case 0:
            break;
        default:
            imageViewer.find('#fourth-image img').attr('src', `/images/restaurants/${restaurantId}/${viewerImages[3]}`);
            imageViewer.find('#third-image img').attr('src', `/images/restaurants/${restaurantId}/${viewerImages[2]}`);
            imageViewer.find('#second-image img').attr('src', `/images/restaurants/${restaurantId}/${viewerImages[1]}`);
            imageViewer.find('#main-image').attr('src', `/images/restaurants/${restaurantId}/${viewerImages[0]}`);
    }

    for (let i = 0; i &lt; reviewImages.length; i++) {
        if (reviewImages[i].images.includes(viewerImages[0])) {
            authorName.text(`${reviewImages[i].author.forename} ${reviewImages[i].author.surname}`);
            authorImage.attr('src', `/images/userImages/${reviewImages[i].author.reducedID}`);
            authorInfo.show();
            break;
        } else {
            authorInfo.hide();
        }
    }

    imageViewer.show();
}

$(document)
    .mousedown((e) => {
        if (!imageViewer.find('table').is(e.target) &amp;&amp; imageViewer.find('table').has(e.target).length === 0) {
            imageViewer.hide();
        }
    })
    .keydown((e) => {
        if (e.keyCode === 27) { // escape key maps to keycode `27`
            imageViewer.hide();
        }
    });


// ================================ WebRTC ================================ \\

const maxImageCount = 5;


let liveVideo, liveVideoContent, newImgCanvas, newImgCanvasContent, origVidWidth, origVidHeight;
const takePhotoButton = $('#take-photo');
const confirmPhotoButton = $('#confirm-photo');
const cancelPhotoButton = $('#cancel-photo');
const reviewSubmitBtn = $('#submit-review');
let canvasContents = new Array(maxImageCount).fill(false);

let canvasArr = [];
let canvasCtx = [];
let deleteButton = [];

$('#add-photo-btn').find('button').click(() => {
    const constraints = {
        audio: false,
        video: {
            facingMode: 'environment',
            width: {min: 960, ideal: 1920, max: 1920},
            height: {min: 540, ideal: 1080, max: 1080},
        }
    };

    navigator.mediaDevices.getUserMedia(constraints)
        .then((stream) => {


            $('#pre-webRTC-col').hide();

            liveVideo = $('#live-video');
            liveVideoContent = liveVideo[0];
            newImgCanvas = $('#new-image');
            newImgCanvasContent = newImgCanvas[0];

            window.stream = stream;
            liveVideoContent.srcObject = stream;

            liveVideoContent.onloadeddata = function () {
                console.log('Video stream active');
                origVidWidth = liveVideoContent.videoWidth;
                origVidHeight = liveVideoContent.videoHeight;

                // alert(`Camera res: ${origVidWidth} x ${origVidHeight}`);

                newImgCanvas.width(liveVideo.width());
                newImgCanvas.height(liveVideo.height());

                newImgCanvasContent.width = origVidWidth;
                newImgCanvasContent.height = origVidHeight;

                for (let i = 0; i &lt; maxImageCount; i++) {
                    const canvasContent = $(`#image-${i}`)[0];
                    canvasContent.width = origVidWidth;
                    canvasContent.height = origVidHeight;
                    canvasArr.push(canvasContent);
                    canvasCtx.push(canvasContent.getContext('2d'));
                    deleteButton.push($(`#delete-canvas${i}`));
                }
            };

            $('#webRTC-col').show();
        })
        .catch((err) => {
            alert('There was an error connecting to your webcam. Please ensure it is connected and try again, or try again later.');
            console.log(`getUserMedia Error: ${err}`);
        });

});

$('.delete-button').click(function () {
    const imageNumber = parseInt(this.id.split('-').pop());
    canvasCtx[imageNumber].clearRect(0, 0, origVidWidth, origVidHeight);
    canvasContents[imageNumber] = false;
    showHTML([takePhotoButton, liveVideo]);
    hideHTML([$(`#image-container-${imageNumber}`), newImgCanvas, confirmPhotoButton, cancelPhotoButton]);
});

takePhotoButton.click(() => {
    newImgCanvasContent.getContext('2d').drawImage(liveVideoContent, 0, 0, origVidWidth, origVidHeight);
    showHTML([newImgCanvas, confirmPhotoButton, cancelPhotoButton]);
    hideHTML([liveVideo, takePhotoButton]);
});

confirmPhotoButton.click(() => {
    for (let i = 0; i &lt; canvasContents.length; i++) {
        if (!canvasContents[i]) {
            canvasCtx[i].drawImage(newImgCanvasContent, 0, 0, origVidWidth, origVidHeight);
            showHTML([$(`#image-container-${i}`)]);
            newImgCanvasContent.getContext('2d').clearRect(0, 0, origVidWidth, origVidHeight);
            canvasContents[i] = true;
            break;
        }
    }

    showHTML([liveVideo, takePhotoButton]);
    hideHTML([newImgCanvas, confirmPhotoButton, cancelPhotoButton]);

    if (canvasContents.every(x => x)) {
        hideHTML([liveVideo, newImgCanvas, takePhotoButton]);
    }
});

cancelPhotoButton.click(() => {
    hideHTML([newImgCanvas, confirmPhotoButton, cancelPhotoButton]);
    showHTML([liveVideo, takePhotoButton]);
});

function hideHTML(array) {
    array.forEach(x => x.hide());
}

function showHTML(array) {
    array.forEach(x => x.show());
}

// ================================ Review Submission ================================ \\

/**
 * Prevent the default action of the review submission form, serialise the webRTC canvasses and send the blobs to
 * the server via AJAX
 * @function submitReview
 */
$('form#review-form').submit((e) => {
    e.preventDefault();
    $('#submitting-div').show();

    let imageBlob = [];
    for (let i = 0; i &lt; maxImageCount; i++) {
        if (canvasContents[i]) {
            imageBlob.push(canvasArr[i].toDataURL());
        }
    }

    // Push empty string to ensure array has at least 2 elements for parsing - weird bug, easy fix
    imageBlob.push('');

    let data = {
        title: $('#review-title').val(),
        rating: $('input.star:checked').val(),
        body: $('#review-body').val(),
        imageBlob: imageBlob,
        restaurantId: restaurantId,
    };

    $.ajax({
        url: '/restaurant/submit_review',
        type: 'POST',
        method: 'POST',
        dataType: 'json',
        data: data,
        success: (result) => {
            if (result.success) {
                $('.row#review-submission-div').hide();
            }
        },
        error: (err) => {
            alert('Review submission failed. Please try again later.');
            console.log(`Review error: ${err}`);
            $('#submitting-div').hide();
        }
    });
});

// ================================ Category List Toggle ================================ \\

let categoriesHidden = true;
const hiddenCategories = $('.hidden-category');

$('#toggle-btn').click(function () {
    categoriesHidden = !categoriesHidden;
    if (categoriesHidden) {
        hiddenCategories.css('display', 'none');
        this.text = 'View more...';
    } else {
        hiddenCategories.css('display', 'inline-block');
        this.text = 'View less...';
    }
});

// ================================ Socket IO ================================ \\

const socket = io();
socket.on('review', (review) => {
    console.log(review);

    const reviewDate = new Date(review.updatedAt);
    const month = reviewDate.getMonth() + 1;
    const day = (reviewDate.getDate() &lt; 10) ? '0' + reviewDate.getDate() : reviewDate.getDate();
    const year = reviewDate.getFullYear();

    const starRating = Math.round(review.restaurantRating);
    let starCount = 0;

    let starHTML = '';

    while (starCount &lt; starRating) {
        starHTML += "&lt;span class='oi oi-star star-highlight'>&lt;/span>";
        starCount++;
    }
    while (starCount &lt; 5) {
        starHTML += "&lt;span class='oi oi-star '>&lt;/span>";
        starCount++;
    }

    let imageHTML = '';

    if (review.images.length === 1) {
        imageHTML = `
            &lt;div class='review-image-main vert-center-parent'>
                &lt;div class='vert-center-child'>
                    &lt;img src='/images/restaurants/${review.restaurant._id}/${review.images[0]}'/>
                &lt;/div>
            &lt;/div>
        `;
    } else if (review.images.length > 1) {
        imageHTML = `
            &lt;tr>
                &lt;td rowspan='2'>
                    &lt;div class='review-image-main'>
                        &lt;img src='/images/restaurants/${review.restaurant._id}/${review.images[0]}'/>
                    &lt;/div>
                &lt;/td>
                &lt;td>
                    &lt;div class='review-image-secondary'>
                        &lt;img src='/images/restaurants/${review.restaurant._id}/${review.images[1]}'/>
                    &lt;/div>
                &lt;/td>
            &lt;/tr>
            &lt;tr>
                &lt;td>
        `;

        if (review.images[2]) {
            imageHTML += `
            &lt;div style="margin-top: 1px;" class='review-image-secondary'>
                &lt;img src='/images/restaurants/${review.restaurant._id}/${review.images[2]}'/>
            &lt;/div>
        `;
        } else {
            imageHTML += `
                &lt;div style='margin-top: 1px; background-color: rgba(0, 0, 0, 0);' class='review-image-secondary'>
                &lt;/div>
            `;
        }
    }

    imageHTML += `
        &lt;/td>
    &lt;/tr>
    `;

    const newReviewHTML = `
        &lt;br/>
        &lt;div class='row no-gutters'>
            &lt;div class='col-lg-2 col-md-12'>
                &lt;div class='vert-center-parent'>
                    &lt;div class='vert-center-child'>
                        &lt;div class='text-center'>
                            &lt;img src='/images/userImages/${review.author.reducedID}' class='mb-2 review-author-image'/>
                            &lt;h5 class='mb-0'>${review.author.forename} ${review.author.surname}&lt;/h5>
                            &lt;p class='mt-1 review-date'>${month}/${day}/${year}&lt;/p>
                        &lt;/div>
                    &lt;/div>
                &lt;/div>
            &lt;/div>
            &lt;div class='col-lg-6 col-md-8'>
                &lt;div class='vert-center-parent'>
                    &lt;div class='vert-center-child'>
                        &lt;div class='row mb-2'>
                            &lt;div class='col'>
                                ${starHTML}
                                &lt;h5 id=${review._id} class='d-inline ml-2'>${review.title}&lt;/h5>
                            &lt;/div>
                        &lt;/div>
                        &lt;div class='row'>
                            &lt;div class='col-lg-12'>
                                &lt;p class='mb-0'>${review.body}&lt;/p>
                            &lt;/div>
                        &lt;/div>
                    &lt;/div>
                &lt;/div>
            &lt;/div>
            &lt;div class='col-lg-4 col-md-4'>
                &lt;div id='review-image-container'>
                    ${imageHTML}
                &lt;/div>
            &lt;/div>
        &lt;/div>
    `;

    $('#reviews').append(newReviewHTML);
});

console.log('Loaded restaurant.js');</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addNewRestaurant">addNewRestaurant</a></li><li><a href="global.html#addTimes">addTimes</a></li><li><a href="global.html#addUser">addUser</a></li><li><a href="global.html#allCategories">allCategories</a></li><li><a href="global.html#allowLocation">allowLocation</a></li><li><a href="global.html#applyWeightings">applyWeightings</a></li><li><a href="global.html#autoCapitalise">autoCapitalise</a></li><li><a href="global.html#autoTitleCase">autoTitleCase</a></li><li><a href="global.html#checkCategoryPicker">checkCategoryPicker</a></li><li><a href="global.html#checkNavPos">checkNavPos</a></li><li><a href="global.html#clearMarkers">clearMarkers</a></li><li><a href="global.html#compareRestaurants">compareRestaurants</a></li><li><a href="global.html#confirmEdit">confirmEdit</a></li><li><a href="global.html#confirmEditHTMLMod">confirmEditHTMLMod</a></li><li><a href="global.html#connect">connect</a></li><li><a href="global.html#createMap">createMap</a></li><li><a href="global.html#createRestaurantPreview">createRestaurantPreview</a></li><li><a href="global.html#deleteImages">deleteImages</a></li><li><a href="global.html#displaySearchResults">displaySearchResults</a></li><li><a href="global.html#editAddress">editAddress</a></li><li><a href="global.html#editFoundAddress">editFoundAddress</a></li><li><a href="global.html#editMapAddress">editMapAddress</a></li><li><a href="global.html#emailCreator">emailCreator</a></li><li><a href="global.html#exitIfDBConnectionFailed">exitIfDBConnectionFailed</a></li><li><a href="global.html#findAddress">findAddress</a></li><li><a href="global.html#generateHash">generateHash</a></li><li><a href="global.html#getAllCategories">getAllCategories</a></li><li><a href="global.html#getNearbyRestaurants">getNearbyRestaurants</a></li><li><a href="global.html#getRestaurantDiv">getRestaurantDiv</a></li><li><a href="global.html#hideCategoryDropdown">hideCategoryDropdown</a></li><li><a href="global.html#hideCategoryPicker">hideCategoryPicker</a></li><li><a href="global.html#hideCategorySelected">hideCategorySelected</a></li><li><a href="global.html#hideHTML">hideHTML</a></li><li><a href="global.html#initialiseDatabase">initialiseDatabase</a></li><li><a href="global.html#initMap">initMap</a></li><li><a href="global.html#initSlideshow">initSlideshow</a></li><li><a href="global.html#lat">lat</a></li><li><a href="global.html#loadEditRestaurantPage">loadEditRestaurantPage</a></li><li><a href="global.html#loadNewRestaurantPage">loadNewRestaurantPage</a></li><li><a href="global.html#loadRestaurantPage">loadRestaurantPage</a></li><li><a href="global.html#lookupAddressToggle">lookupAddressToggle</a></li><li><a href="global.html#lookupMapToggle">lookupMapToggle</a></li><li><a href="global.html#manageGeolocation">manageGeolocation</a></li><li><a href="global.html#matchCategories">matchCategories</a></li><li><a href="global.html#pageCount">pageCount</a></li><li><a href="global.html#passportLogin">passportLogin</a></li><li><a href="global.html#passportSignUp">passportSignUp</a></li><li><a href="global.html#populateCollections">populateCollections</a></li><li><a href="global.html#populateFunction">populateFunction</a></li><li><a href="global.html#populateRestaurants">populateRestaurants</a></li><li><a href="global.html#populateReviews">populateReviews</a></li><li><a href="global.html#populateUsers">populateUsers</a></li><li><a href="global.html#postContactForm">postContactForm</a></li><li><a href="global.html#previewImage">previewImage</a></li><li><a href="global.html#processImages">processImages</a></li><li><a href="global.html#processRestaurants">processRestaurants</a></li><li><a href="global.html#publishRestaurant">publishRestaurant</a></li><li><a href="global.html#redirectAfterVerified">redirectAfterVerified</a></li><li><a href="global.html#refreshTopRestaurants">refreshTopRestaurants</a></li><li><a href="global.html#removeCategory">removeCategory</a></li><li><a href="global.html#removeSelectedDay">removeSelectedDay</a></li><li><a href="global.html#saveRestaurant">saveRestaurant</a></li><li><a href="global.html#scrollToRestaurant">scrollToRestaurant</a></li><li><a href="global.html#search">search</a></li><li><a href="global.html#selectCategory">selectCategory</a></li><li><a href="global.html#sendConfirmationEmail">sendConfirmationEmail</a></li><li><a href="global.html#sendEmail">sendEmail</a></li><li><a href="global.html#sendSupportRequest">sendSupportRequest</a></li><li><a href="global.html#setLoginFormPosition">setLoginFormPosition</a></li><li><a href="global.html#showCategoryDropdown">showCategoryDropdown</a></li><li><a href="global.html#showHTML">showHTML</a></li><li><a href="global.html#sortResults">sortResults</a></li><li><a href="global.html#storage">storage</a></li><li><a href="global.html#submitReview">submitReview</a></li><li><a href="global.html#submitSearchQuery">submitSearchQuery</a></li><li><a href="global.html#updateCategoryCheckboxes">updateCategoryCheckboxes</a></li><li><a href="global.html#updateDetails">updateDetails</a></li><li><a href="global.html#updateDisplayFlags">updateDisplayFlags</a></li><li><a href="global.html#updateFeaturesCheckboxes">updateFeaturesCheckboxes</a></li><li><a href="global.html#updateImagePreviews">updateImagePreviews</a></li><li><a href="global.html#updateList">updateList</a></li><li><a href="global.html#updateNearbyDistance">updateNearbyDistance</a></li><li><a href="global.html#userLogin">userLogin</a></li><li><a href="global.html#validateSignUpForm">validateSignUpForm</a></li><li><a href="global.html#validPassword">validPassword</a></li><li><a href="global.html#verifyEmail">verifyEmail</a></li><li><a href="global.html#verifyUser">verifyUser</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu May 31 2018 11:32:56 GMT+0100 (GMT Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
